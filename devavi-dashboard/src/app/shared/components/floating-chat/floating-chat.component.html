<!-- Circular Chat Toggle Button -->
<button *ngIf="!showChatPopup" class="chat-toggle-btn" [ngClass]="{ 'highlighted': showMessageFlag }"
    (click)="toggleChat()">
    ğŸ’¬
</button>


<div *ngIf="showChatPopup" class="floating-chat">

    <div class="chat-header">
        DevAvi Chat ğŸ’¬
        <button class="close-btn" (click)="toggleChat()">âœ–</button>
    </div>

    <div class="chat-body">
        <!-- Sidebar with search and user list -->
        <div class="left-sidebar">
            <input type="text" [(ngModel)]="searchTerm" (input)="onSearchChange()" placeholder="Search..." />

            <div class="user-list">
                <div *ngFor="let user of filteredUsers" class="user" [class.active]="user.name === activeUser.name"
                    (click)="selectUser(user)">
                    <span class="status" [class.online]="user.online"></span>

                    <!-- ğŸ‘‡ Add user icon -->
                    <span class="user-icon">ğŸ‘¤</span>

                    {{ user._id == currentUserId ? 'Self' : user.name }}

                    <span *ngIf="user.unreadCount > 0" class="badge">{{ user.unreadCount }}</span>
                </div>

            </div>
        </div>

        <!-- Chat content -->
        <div class="right-chat">
            <div class="chat-with">Chat with {{ activeUser.name }}</div>


            <div class="chat-history" #chatBox (onscroll)="loadMoreMessages()">
                <div *ngFor="let msg of messages" class="msg" [class.me]="msg.sender === currentUserId">
                    <!-- <pre>{{msg|json}}</pre>
                    <pre>{{messages|json}}</pre> -->
                    <div class="meta">
                        {{ msg.sender === currentUserId ? 'You' : getUserNameById(msg.sender) }} â€¢
                        {{ msg.createdAt | date: 'short' }}
                    </div>

                    <div *ngIf="msg.messageType !== 'file'" class="text">{{ msg.content }}</div>

                    <div *ngIf="msg.messageType === 'file' && msg.fileMeta">
                        <a [href]="msg.fileMeta.path" target="_blank">ğŸ“ {{ msg.fileMeta.originalName }}</a>
                    </div>

                    <div *ngIf="msg.sender === currentUserId">
                        <span class="read-status">
                            {{ msg.read ? 'ğŸ‘€ Read' : 'âœ”ï¸ Sent' }}
                        </span>
                    </div>
                </div>


            </div>


            <!-- File preview -->
            <div class="file-preview" *ngIf="selectedFiles.length > 0">
                <div *ngFor="let file of selectedFiles">
                    ğŸ“ {{ file.name }}
                </div>
            </div>

            <!-- Chat input -->
            <!-- Chat input -->
            <div class="chat-input">
                <textarea [(ngModel)]="messageText" placeholder="Type a message..." (keydown.enter)="onEnter($event)"
                    rows="1"></textarea>

                <!-- <div class="file-input-wrapper">
                    <input type="file" (change)="handleFileChange($event)" multiple />
                    <label class="file-input-label">ğŸ“</label>
                </div> -->

                <button (click)="sendMessage()">Send</button>
            </div>


            <!-- <input type="file" (change)="onFileSelected($event)" /> -->

            <!-- Emoji picker -->
            <emoji-mart *ngIf="showEmojiPicker" (emojiSelect)="addEmoji($event)"></emoji-mart>
        </div>
    </div>
</div>